# ğŸ”· 1. ä»€ä¹ˆæ˜¯ç±»è£…é¥°å™¨ï¼Ÿ

è£…é¥°å™¨ä¸ä»…å¯ä»¥ç”¨å‡½æ•°å®ç°ï¼Œä¹Ÿå¯ä»¥ç”¨ **ç±»** å®ç°ã€‚

ç±»è£…é¥°å™¨çš„æœ¬è´¨ï¼š

> **ç±»è£…é¥°å™¨æ˜¯ä¸€ä¸ªâ€œå®ç°äº† `__call__` æ–¹æ³•çš„ç±»â€ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ã€‚**

æ¢å¥è¯è¯´ï¼š
ç±»æœ¬èº«å°±æ˜¯ä¸€ä¸ªâ€œè£…é¥°å™¨å·¥å‚â€ï¼Œå®ƒè¿”å›çš„å®ä¾‹è´Ÿè´£åŒ…è£…åŸå‡½æ•°ã€‚

å…¸å‹ç»“æ„å¦‚ä¸‹ï¼š

```python
class Decorator:
    def __init__(self, func):
        # ä¼ å…¥è¢«è£…é¥°çš„å‡½æ•°
        self.func = func

    def __call__(self, *args, **kwargs):
        # åŒ…è£…é€»è¾‘
        print("Before function")
        result = self.func(*args, **kwargs)
        print("After function")
        return result
```

ä½¿ç”¨ï¼š

```python
@Decorator
def hello():
    print("hello")

hello()
```

------

# ğŸ”· 2. ç±»è£…é¥°å™¨çš„è¿è¡Œæœºåˆ¶ï¼ˆç†è§£æ ¸å¿ƒï¼‰

ä½¿ç”¨è¯­æ³•ï¼š

```python
@Decorator
def func():
    pass
```

ç­‰ä»·äºï¼š

```python
func = Decorator(func)
```

ä¹Ÿå°±æ˜¯è¯´ï¼š
ğŸ‘‰ *å‡½æ•°å˜æˆäº† Decorator ç±»çš„ä¸€ä¸ªå®ä¾‹*
ğŸ‘‰ è°ƒç”¨ `func()` å®é™…ä¸Šæ˜¯åœ¨è°ƒç”¨å®ä¾‹çš„ `__call__()` æ–¹æ³•

------

# ğŸ”· 3. å®Œæ•´ç¤ºä¾‹ï¼ˆæœ€ç®€å•ã€æœ€ç›´è§‚ï¼‰

```python
class Log:
    def __init__(self, func):
        self.func = func

    def __call__(self, *args, **kwargs):
        print(f"Calling {self.func.__name__}")
        return self.func(*args, **kwargs)

@Log
def add(a, b):
    return a + b

print(add(3, 4))
```

è¾“å‡ºï¼š

```
Calling add
7
```

æ³¨æ„ï¼š
æ­¤æ—¶ `add` ä¸å†æ˜¯å‡½æ•°ï¼Œè€Œæ˜¯ `Log` ç±»çš„å®ä¾‹ã€‚

------

# ğŸ”· 4. ä¸ºä»€ä¹ˆè¦ç”¨ç±»è£…é¥°å™¨ï¼Ÿ

ç±»è£…é¥°å™¨æ¯”å‡½æ•°è£…é¥°å™¨é€‚åˆï¼š

### âœ” éœ€è¦â€œçŠ¶æ€â€çš„å¤æ‚åŠŸèƒ½

ä¾‹å¦‚ï¼š

- é™æµï¼ˆæŒç»­è®°å½•æ¬¡æ•°ï¼‰
- ç¼“å­˜ï¼ˆcache åœ¨å®ä¾‹é‡Œï¼‰
- é‡è¯•æœºåˆ¶ï¼ˆç»Ÿè®¡å¤±è´¥æ¬¡æ•°ï¼‰
- ç»Ÿè®¡è°ƒç”¨æ¬¡æ•°
- è·Ÿè¸ªæ€§èƒ½

ç±»å¯ä»¥æŒä¹…ä¿å­˜çŠ¶æ€ï¼Œè€Œé—­åŒ…å¯è¯»æ€§å·®ä¸”ä¸æ˜“ç»´æŠ¤ã€‚

### âœ” å¯æ‰©å±•ç»“æ„ï¼ˆæ›´æ¸…æ™°ï¼Œå¯è¯»æ€§å¼ºï¼‰

è£…é¥°å™¨é€»è¾‘å¤æ‚æ—¶ï¼Œç±»è£…é¥°å™¨æ›´å¥½ç»„ç»‡ä»£ç ã€‚

------

# ğŸ”· 5. ç±»è£…é¥°å™¨å¸¦å‚æ•°ï¼ˆè£…é¥°å™¨å·¥å‚ï¼‰

ä½ ä¹Ÿå¯ä»¥ç»™ç±»è£…é¥°å™¨æ·»åŠ å‚æ•°ï¼š

âŒ é”™è¯¯å†™æ³•ï¼ˆä¸èƒ½ç›´æ¥è¿™ä¹ˆåšï¼‰ï¼š

```python
@MyDecorator(3)
def func(): ...
```

å› ä¸ºè£…é¥°å™¨æœºåˆ¶è¦æ±‚ Decorator åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼ˆå°±æ˜¯å‡½æ•°ï¼‰ã€‚
æ‰€ä»¥å¿…é¡»è¿™æ ·å†™ï¼š

âœ” æ­£ç¡®çš„ä¸‰å±‚ç»“æ„ï¼š

```python
class Retry:
    def __init__(self, times):
        self.times = times

    def __call__(self, func):
        def wrapper(*args, **kwargs):
            for i in range(self.times):
                try:
                    return func(*args, **kwargs)
                except Exception:
                    if i == self.times - 1:
                        raise
        return wrapper
```

ä½¿ç”¨ï¼š

```python
@Retry(times=3)
def unstable():
    ...
```

å·¥ä½œæµç¨‹ï¼š

1. `Retry(times=3)` â†’ åˆ›å»ºè£…é¥°å™¨å¯¹è±¡
2. è°ƒç”¨ `__call__(func)` â†’ è¿”å› wrapper

------

# ğŸ”· 6. å¤šå±‚è£…é¥°å™¨ï¼ˆç±»è£…é¥°å™¨ä¹Ÿå¯ä»¥é“¾å¼ä½¿ç”¨ï¼‰

```python
@D1
@D2
class MyClass:
    ...
```

æˆ–è€…ï¼š

```python
@D1
@D2
def f():
    ...
```

æ‰§è¡Œé¡ºåºï¼ˆä»ä¸‹åˆ°ä¸Šï¼‰ï¼š

```
f = D1(D2(f))
```

------

# ğŸ”· 7. å®æˆ˜ï¼šç»Ÿè®¡å‡½æ•°è°ƒç”¨æ¬¡æ•°ï¼ˆç±»è£…é¥°å™¨ä¼˜åŠ¿ç¤ºä¾‹ï¼‰

```python
class Count:
    def __init__(self, func):
        self.func = func
        self.count = 0

    def __call__(self, *args, **kwargs):
        self.count += 1
        print(f"{self.func.__name__} called {self.count} times")
        return self.func(*args, **kwargs)

@Count
def hello():
    print("Hello")
```

è°ƒç”¨ï¼š

```python
hello()
hello()
```

è¾“å‡ºï¼š

```
hello called 1 times
Hello
hello called 2 times
Hello
```

å¦‚æœç”¨å‡½æ•°è£…é¥°å™¨ï¼Œè¿™ç§çŠ¶æ€ä¿å­˜ä¼šæ¯”è¾ƒå¤æ‚ã€‚

------

# ğŸ”· 8. å®æˆ˜ï¼šå‡½æ•°æ‰§è¡Œç¼“å­˜ï¼ˆå¯å–ä»£ functools.lru_cacheï¼‰

```python
class Cache:
    def __init__(self, func):
        self.func = func
        self.store = {}

    def __call__(self, *args):
        if args in self.store:
            return self.store[args]
        result = self.func(*args)
        self.store[args] = result
        return result

@Cache
def fib(n):
    if n <= 2:
        return 1
    return fib(n-1) + fib(n-2)
```

è¿™å°±æ˜¯ä¸ªæ‰‹å†™ç‰ˆ LRUï¼ˆç®€å•ç‰ˆï¼‰ã€‚

------

# ğŸ”· 9. å®æˆ˜ï¼šé™æµå™¨ï¼ˆRate Limiterï¼‰

```python
import time

class RateLimit:
    def __init__(self, max_calls, period=1):
        self.max_calls = max_calls
        self.period = period
        self.calls = []

    def __call__(self, func):
        def wrapper(*args, **kwargs):
            now = time.time()
            self.calls = [t for t in self.calls if now - t < self.period]
            if len(self.calls) >= self.max_calls:
                raise RuntimeError("Rate limit exceeded")
            self.calls.append(now)
            return func(*args, **kwargs)
        return wrapper
```

ä½¿ç”¨ï¼š

```python
@RateLimit(3, period=2)
def test():
    print("run")
```

------

# ğŸ”· 10. è£…é¥°ç±»ï¼ˆè€Œä¸æ˜¯è£…é¥°å‡½æ•°ï¼‰

ç±»è£…é¥°å™¨ä¹Ÿå¯ä»¥ä¿®é¥°ä¸€ä¸ªç±»ï¼Œè€Œä¸æ˜¯å‡½æ•°ï¼š

```python
def add_repr(cls):
    cls.__repr__ = lambda self: f"{cls.__name__}({self.__dict__})"
    return cls

@add_repr
class User:
    def __init__(self, name):
        self.name = name

print(User("Jack"))
```

è¾“å‡ºï¼š

```
User({'name': 'Jack'})
```

ç‰¹ç‚¹ï¼š

- æ¥æ”¶çš„æ˜¯ç±»
- è¿”å›çš„æ˜¯ç±»
- ç±»è£…é¥°å™¨å¸¸ç”¨äº ORM / DI æ¡†æ¶ ç»“æ„å¢å¼º

------

# ğŸ”· 11. ç±»è£…é¥°å™¨ vs å‡½æ•°è£…é¥°å™¨ï¼ˆæ€ä¹ˆé€‰ï¼‰

| åœºæ™¯           | ç”¨ç±»è£…é¥°å™¨ | ç”¨å‡½æ•°è£…é¥°å™¨ |
| -------------- | ---------- | ------------ |
| é€»è¾‘ç®€å•       | âŒ          | âœ”            |
| éœ€è¦å¤æ‚çŠ¶æ€   | âœ”          | âŒ            |
| ç»“æ„åŒ–ã€å¯æ‰©å±• | âœ”          | âŒ            |
| å‡ºäºä¹ æƒ¯æˆ–é£æ ¼ | æ ¹æ®å›¢é˜Ÿ   | æ ¹æ®å›¢é˜Ÿ     |

ä¸€å¥è¯æ€»ç»“ï¼š

> **é€»è¾‘å¤æ‚æ—¶ä¼˜å…ˆç”¨ç±»è£…é¥°å™¨ï¼Œé€»è¾‘ç®€å•æ—¶ç”¨å‡½æ•°è£…é¥°å™¨ã€‚**

------

# ğŸ”· 12. è¶…å¼ºæ€»ç»“ï¼ˆ10 ç§’è®°ä½ï¼‰

### âœ” ç±»è£…é¥°å™¨æœ¬è´¨ï¼š

**å®ç°äº† `__call__` çš„ç±»ï¼Œç”¨æ¥åŒ…è£…å‡½æ•°ï¼ˆæˆ–ç±»ï¼‰ã€‚**

### âœ” ä½¿ç”¨æ–¹å¼ï¼š

```python
@MyDecorator
def f(): ...
```

### âœ” å·¥ä½œæµç¨‹ï¼š

- å®šä¹‰æ—¶æ‰§è¡Œï¼š`f = MyDecorator(f)`
- è°ƒç”¨æ—¶æ‰§è¡Œï¼š`f()` â†’ å®ä¾‹çš„ `__call__()`

### âœ” ä¼˜åŠ¿ï¼š

- ä¿å­˜çŠ¶æ€ç®€å•
- æ›´æ¸…æ™°å¯æ‰©å±•
- æ›´é€‚åˆä¸šåŠ¡é€»è¾‘

