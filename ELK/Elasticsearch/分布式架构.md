## ä¸€ã€Elasticsearch åˆ†å¸ƒå¼æ¶æ„æ€»ä½“å›¾

![Image](./assets/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/0NddRsJEqAxpzOTpc.png)

![Image](./assets/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/61be38b25fdb7878686b93e0_605c9c8427508704ace5ef96_ES_shards.png)

![Image](./assets/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/image-3-1-1024x424.png)

**ES æœ¬è´¨ = åˆ†å¸ƒå¼æ–‡æ¡£æœç´¢ä¸åˆ†æå¼•æ“**

æ ¸å¿ƒç›®æ ‡ï¼š

- **æ°´å¹³æ‰©å±•ï¼ˆScale Outï¼‰**
- **é«˜å¯ç”¨ï¼ˆHAï¼‰**
- **é«˜æ€§èƒ½æŸ¥è¯¢ + å®æ—¶å†™å…¥**

------

## äºŒã€æ ¸å¿ƒæ¦‚å¿µï¼ˆç†è§£ ES æ¶æ„å¿…é¡»æŒæ¡ï¼‰

### 1ï¸âƒ£ Clusterï¼ˆé›†ç¾¤ï¼‰

- ä¸€ä¸ª ES é›†ç¾¤ç”± **å¤šä¸ª Node ç»„æˆ**
- åŒä¸€é›†ç¾¤ï¼š
  - `cluster.name` ç›¸åŒ
- é›†ç¾¤çŠ¶æ€ï¼ˆCluster Stateï¼‰ï¼š
  - ç´¢å¼•
  - åˆ†ç‰‡
  - èŠ‚ç‚¹
  - æ˜ å°„ï¼ˆmappingï¼‰

ğŸ“Œ **é›†ç¾¤çŠ¶æ€ç”± Master èŠ‚ç‚¹ç»Ÿä¸€ç»´æŠ¤**

------

### 2ï¸âƒ£ Nodeï¼ˆèŠ‚ç‚¹ï¼‰è§’è‰²åˆ’åˆ†ï¼ˆé‡ç‚¹ï¼‰

#### ï¼ˆ1ï¼‰Master èŠ‚ç‚¹

**èŒè´£**

- ç®¡ç†é›†ç¾¤çŠ¶æ€
- åˆ†ç‰‡åˆ†é…
- èŠ‚ç‚¹åŠ å…¥ / é€€å‡º
- ç´¢å¼•åˆ›å»º / åˆ é™¤

ğŸ“Œ ç‰¹ç‚¹ï¼š

- **ä¸å‚ä¸æ•°æ®è¯»å†™**
- è¦æ±‚ï¼š**ç¨³å®šã€å°‘ GC**

é…ç½®ï¼š

```yaml
node.roles: [ master ]
```

------

#### ï¼ˆ2ï¼‰Data èŠ‚ç‚¹

**èŒè´£**

- å­˜å‚¨æ•°æ®ï¼ˆShardï¼‰
- æ‰§è¡Œæœç´¢ & èšåˆ
- æ‰¿æ‹… IO / CPU å‹åŠ›

é…ç½®ï¼š

```yaml
node.roles: [ data ]
```

------

#### ï¼ˆ3ï¼‰Coordinating èŠ‚ç‚¹ï¼ˆåè°ƒèŠ‚ç‚¹ï¼‰

**èŒè´£**

- æ¥æ”¶è¯·æ±‚
- è¯·æ±‚è·¯ç”±
- èšåˆç»“æœï¼ˆreduceï¼‰

ğŸ“Œ æ‰€æœ‰èŠ‚ç‚¹é»˜è®¤éƒ½èƒ½å½“åè°ƒèŠ‚ç‚¹
ğŸ“Œ é«˜å¹¶å‘æŸ¥è¯¢åœºæ™¯å¯ç‹¬ç«‹éƒ¨ç½²

é…ç½®ï¼š

```yaml
node.roles: [ ]
```

------

#### ï¼ˆ4ï¼‰Ingest èŠ‚ç‚¹ï¼ˆå¯é€‰ï¼‰

- æ‰§è¡Œ Pipelineï¼ˆæ•°æ®é¢„å¤„ç†ï¼‰
- æ—¥å¿—æ¸…æ´—ã€å­—æ®µæ‹†åˆ†

```yaml
node.roles: [ ingest ]
```

------

### 3ï¸âƒ£ Index / Shard / Replicaï¼ˆåˆ†å¸ƒå¼æ ¸å¿ƒï¼‰

#### Indexï¼ˆç´¢å¼•ï¼‰

- ç±»ä¼¼ **æ•°æ®åº“ä¸­çš„è¡¨**

------

#### Shardï¼ˆåˆ†ç‰‡ï¼‰

- ç´¢å¼•è¢«æ‹†åˆ†æˆå¤šä¸ª **Primary Shard**
- æ¯ä¸ª shard æ˜¯ä¸€ä¸ª **ç‹¬ç«‹ Lucene Index**

ğŸ“Œ **Shard æ˜¯ ES å¹¶è¡Œä¸æ‰©å±•çš„æœ€å°å•ä½**

```text
Index
 â”œâ”€â”€ Shard 0
 â”œâ”€â”€ Shard 1
 â””â”€â”€ Shard 2
```

------

#### Replicaï¼ˆå‰¯æœ¬ï¼‰

- Primary Shard çš„æ‹·è´
- æä¾›ï¼š
  - é«˜å¯ç”¨
  - è¯»æ€§èƒ½æå‡

ğŸ“Œ å‰¯æœ¬ä¸ä¼šå’Œä¸»åˆ†ç‰‡åœ¨åŒä¸€èŠ‚ç‚¹

```text
Primary Shard 0  â†’ Replica Shard 0
```

------

## ä¸‰ã€æ•°æ®å†™å…¥æµç¨‹ï¼ˆWrite Pathï¼‰

![Image](./assets/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/elasticsearch-reference-data_processing_flow.png)

![Image](./assets/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/elasticsearch-reference-shard-allocation-awareness-two-racks.png)

### å†™å…¥æµç¨‹ï¼š

1. Client â†’ ä»»æ„èŠ‚ç‚¹ï¼ˆåè°ƒèŠ‚ç‚¹ï¼‰
2. è®¡ç®—æ–‡æ¡£ `_id` â†’ hash â†’ å®šä½ Primary Shard
3. Primary Shard å†™å…¥
4. åŒæ­¥å†™å…¥ Replica Shard
5. è¿”å›æˆåŠŸ

ğŸ“Œ **å†™å…¥ä¸€è‡´æ€§**

- é»˜è®¤ï¼š`quorum`ï¼ˆ7.x åè‡ªåŠ¨ç®¡ç†ï¼‰
- Primary æˆåŠŸ + Replica æˆåŠŸæ‰è¿”å›

------

## å››ã€æŸ¥è¯¢æµç¨‹ï¼ˆSearch Pathï¼‰

![Image](./assets/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/es-searching-data-flow.png)

![Image](./assets/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/1tIXyg70eb5UXTWeGhyQijg.png)

### ä¸¤é˜¶æ®µæŸ¥è¯¢æ¨¡å‹

#### 1ï¸âƒ£ Query Phaseï¼ˆScatterï¼‰

- åè°ƒèŠ‚ç‚¹å°†æŸ¥è¯¢åˆ†å‘åˆ°æ‰€æœ‰ç›¸å…³ Shard
- å„ Shard æœ¬åœ°æŸ¥è¯¢

#### 2ï¸âƒ£ Fetch Phaseï¼ˆGatherï¼‰

- æ±‡æ€»ç»“æœ
- æ’åºã€èšåˆ
- è¿”å›ç»™å®¢æˆ·ç«¯

ğŸ“Œ **æŸ¥è¯¢æ€§èƒ½ç“¶é¢ˆ**

- Shard æ•°é‡
- ç½‘ç»œ
- èšåˆå¤æ‚åº¦

------

## äº”ã€Master é€‰ä¸¾æœºåˆ¶ï¼ˆZen2ï¼‰

### é€‰ä¸¾ç‰¹ç‚¹

- åŸºäº **Raft æ€æƒ³**
- **è¿‡åŠæŠ•ç¥¨ï¼ˆQuorumï¼‰**
- é˜²æ­¢è„‘è£‚

ğŸ“Œ **å»ºè®®**

- Master èŠ‚ç‚¹æ•°é‡ï¼š**å¥‡æ•° â‰¥ 3**

```text
3 Master èŠ‚ç‚¹
è‡³å°‘ 2 ä¸ªå­˜æ´» â†’ é›†ç¾¤å¯ç”¨
```

------

## å…­ã€Shard åˆ†é… & è´Ÿè½½å‡è¡¡

### åˆ†ç‰‡åˆ†é…ç­–ç•¥

- åŒä¸€ç´¢å¼•çš„ Primary å’Œ Replica ä¸åœ¨åŒä¸€èŠ‚ç‚¹
- èŠ‚ç‚¹åŠ å…¥ / é€€å‡ºè‡ªåŠ¨ Rebalance

æ§åˆ¶å‚æ•°ï¼š

```yaml
cluster.routing.allocation.enable: all
cluster.routing.rebalance.enable: all
```

------

## ä¸ƒã€ES åˆ†å¸ƒå¼æ¶æ„çš„ä¼˜åŠ¿ä¸ä»£ä»·

### âœ… ä¼˜åŠ¿

- æ°´å¹³æ‰©å±•
- é«˜å¯ç”¨
- å®æ—¶æœç´¢
- å¤©ç„¶åˆ†å¸ƒå¼

### âŒ ä»£ä»·

- é›†ç¾¤çŠ¶æ€å¤æ‚
- Shard è¿‡å¤š â†’ æ€§èƒ½ä¸‹é™
- ç½‘ç»œé€šä¿¡æˆæœ¬

------

## å…«ã€å…¸å‹ç”Ÿäº§æ¶æ„æ¨èï¼ˆè¿ç»´è§’åº¦ï¼‰

### ä¸­å°è§„æ¨¡ï¼ˆâ‰¤10 èŠ‚ç‚¹ï¼‰

```text
3 Master
5~7 Dataï¼ˆå…¼åè°ƒï¼‰
```

------

### æ—¥å¿— / APM åœºæ™¯ï¼ˆä½ ä»¬è¿ç»´åˆ†æå¾ˆå¸¸è§ï¼‰

```text
3 Master
6~12 Data Hot
2 Coordinating
1~2 Ingest
```

------

## ä¹ã€å¸¸è§è¯¯åŒºï¼ˆéå¸¸é‡è¦ï¼‰

âŒ Shard è¶Šå¤šè¶Šå¥½
âŒ æ‰€æœ‰èŠ‚ç‚¹éƒ½å½“ Master
âŒ Master å’Œ Data æ··ç”¨åœ¨é«˜è´Ÿè½½é›†ç¾¤
âŒ å¿½ç•¥ JVM / GC

