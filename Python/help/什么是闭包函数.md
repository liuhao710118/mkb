# ğŸ§  ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿï¼ˆä¸€å¥è¯è§£é‡Šï¼‰

**é—­åŒ… = å‡½æ•° + å®ƒè®°ä½çš„å¤–éƒ¨å˜é‡ç¯å¢ƒï¼ˆçŠ¶æ€ï¼‰**

é€šä¿—ç†è§£ï¼š
ä¸€ä¸ªå†…éƒ¨å‡½æ•°æŠŠå¤–éƒ¨å‡½æ•°çš„å˜é‡â€œå¸¦å›äº†å®¶â€ï¼Œå³ä½¿å¤–éƒ¨å‡½æ•°å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œè¿™äº›å˜é‡ä¾æ—§å¯ç”¨ã€‚

------

# ğŸ” é—­åŒ…çš„ä¸‰ä¸ªå¿…è¦æ¡ä»¶

é—­åŒ…å¿…é¡»æ»¡è¶³ **å…¨éƒ¨** æ¡ä»¶ï¼š

1. **å†…éƒ¨å‡½æ•°ï¼ˆinner functionï¼‰**
2. **å†…éƒ¨å‡½æ•°å¼•ç”¨äº†å¤–éƒ¨å‡½æ•°çš„å˜é‡**
3. **å¤–éƒ¨å‡½æ•°è¿”å›å†…éƒ¨å‡½æ•°**

ç¤ºä¾‹ï¼ˆç»å…¸é—­åŒ…ï¼‰ï¼š

```python
def outer(x):
    def inner(y):
        return x + y   # å†…éƒ¨ä½¿ç”¨å¤–éƒ¨å˜é‡ x
    return inner       # è¿”å›å†…éƒ¨å‡½æ•°

f = outer(10)
print(f(5))  # 15
```

è¿™é‡Œ `f` æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œå› ä¸ºå®ƒè®°ä½äº† `x=10`ã€‚

------

# ğŸ§© ä¸ºä»€ä¹ˆé—­åŒ…é‡è¦ï¼Ÿé—­åŒ…çš„ç”¨é€”

é—­åŒ…å¸¸ç”¨äºï¼š

1. **ä¿æŒçŠ¶æ€**ï¼ˆä¸éœ€è¦ç”¨ç±»ï¼‰
2. **åˆ›å»ºå‡½æ•°å·¥å‚ï¼ˆå·¥å‚æ¨¡å¼ï¼‰**
3. **æ›¿ä»£ç±»çš„è½»é‡çº§å·¥å…·**
4. **è£…é¥°å™¨çš„æ ¸å¿ƒåŸç†**
5. **å»¶è¿Ÿæ‰§è¡Œ**

------

# ğŸ“Œ 1. é—­åŒ…å¦‚ä½•ä¿æŒçŠ¶æ€ï¼Ÿ

ä¸€ä¸ªä¸ç”¨ç±»çš„è®¡æ•°å™¨ï¼š

```python
def counter():
    count = 0
    def add():
        nonlocal count
        count += 1
        return count
    return add

c = counter()
print(c())  # 1
print(c())  # 2
print(c())  # 3
```

å…³é”®è¯­å¥ï¼š

```python
nonlocal count
```

æ„æ€ï¼š
ä½¿ç”¨å¤–éƒ¨å‡½æ•°çš„å˜é‡ï¼Œè€Œä¸æ˜¯åˆ›å»ºæ–°çš„å±€éƒ¨å˜é‡ã€‚

------

# ğŸ“Œ 2. é—­åŒ…å‡½æ•°å·¥å‚ï¼ˆè¿”å›å¸¦å‚æ•°çš„å‡½æ•°ï¼‰

å‡è®¾ä½ æƒ³åˆ›å»ºå¤šä¸ªä¸åŒå€ç‡çš„ä¹˜æ³•å™¨ï¼š

```python
def make_multiplier(m):
    def multiply(n):
        return m * n
    return multiply

double = make_multiplier(2)
triple = make_multiplier(3)

print(double(10))  # 20
print(triple(10))  # 30
```

é—­åŒ…ä¿ç•™äº† `m` çš„å€¼ï¼Œå½¢æˆä¸åŒçš„åŠŸèƒ½å‡½æ•°ã€‚

------

# ğŸ“Œ 3. é—­åŒ… vs æ™®é€šå‡½æ•°

æ™®é€šå‡½æ•°æ— æ³•è®°ä½ä¹‹å‰çš„çŠ¶æ€ï¼š

```python
def add(n):
    return n + 1
```

æ¯æ¬¡è°ƒç”¨éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚

è€Œé—­åŒ…å¯ä»¥è®°ä½å†…éƒ¨çŠ¶æ€ï¼š

```python
c = counter()
c()  # 1
c()  # 2
```

------

# ğŸ“Œ 4. é—­åŒ…ä¸è£…é¥°å™¨çš„å…³ç³»ï¼ˆé—­åŒ…æ˜¯è£…é¥°å™¨çš„åŸºç¡€ï¼‰

å…¸å‹è£…é¥°å™¨å†…éƒ¨æœ¬è´¨å°±æ˜¯ä¸€ä¸ªé—­åŒ…ï¼š

```python
def log(func):
    def wrapper(*args, **kwargs):
        print("call", func.__name__)
        return func(*args, **kwargs)
    return wrapper
```

è¿™é‡Œ `wrapper` è®°ä½äº† `func`ï¼Œå½¢æˆé—­åŒ…ã€‚

------

# ğŸ“Œ 5. æŸ¥çœ‹é—­åŒ…æ•è·çš„å˜é‡

ç”¨ `__closure__` æŸ¥çœ‹ï¼š

```python
f = outer(10)

print(f.__closure__)
print(f.__closure__[0].cell_contents)
```

è¾“å‡ºï¼š

```
(<cell at 0x...: int object at ...>,)
10
```

è¯´æ˜é—­åŒ…ç¡®å®å­˜äº†å¤–éƒ¨å˜é‡ã€‚

------

# ğŸ“Œ 6. é—­åŒ…ä¸­çš„å¸¸è§å‘ï¼šå¾ªç¯å˜é‡

ç»å…¸é”™è¯¯ç¤ºä¾‹ï¼š

```python
funcs = []
for i in range(3):
    def f():
        return i
    funcs.append(f)

print(funcs[0]())  # 2
print(funcs[1]())  # 2
print(funcs[2]())  # 2
```

åŸå› ï¼šé—­åŒ…ä¿å­˜çš„æ˜¯å˜é‡ï¼Œè€Œä¸æ˜¯å½“æ—¶çš„å€¼ã€‚

æ­£ç¡®å†™æ³•ï¼š

### æ–¹æ³• 1ï¼šç»™å‚æ•°ç»‘å®šé»˜è®¤å€¼

```python
funcs = []
for i in range(3):
    def f(i=i):  # ç»‘å®šé»˜è®¤å€¼
        return i
    funcs.append(f)
```

### æ–¹æ³• 2ï¼šå†åŒ…ä¸€å±‚å¤–å‡½æ•°

```python
def make(i):
    def f():
        return i
    return f

funcs = [make(i) for i in range(3)]
```

------

# ğŸ“Œ 7. nonlocal è¯¦è§£ï¼ˆé—­åŒ…ä¿®æ”¹å¤–éƒ¨å˜é‡ï¼‰

å¦‚æœè¦åœ¨é—­åŒ…ä¸­ä¿®æ”¹å¤–å±‚å‡½æ•°çš„å˜é‡ï¼Œå¿…é¡»ç”¨ `nonlocal`ï¼š

```python
def outer():
    x = 10
    def inner():
        nonlocal x
        x += 1
        return x
    return inner

f = outer()
print(f())  # 11
print(f())  # 12
```

ğŸ›‘ æ³¨æ„
å¦‚æœä¸å†™ `nonlocal`ï¼Œä¼šæŠ¥é”™æˆ–åˆ›å»ºæ–°å±€éƒ¨å˜é‡ã€‚

------

# ğŸ“Œ 8. é—­åŒ… VS ç±»ï¼ˆè°æ›´å¥½ï¼Ÿï¼‰

ä»¥ä¸‹æ˜¯ç”¨ç±»å®ç°çš„è®¡æ•°å™¨ï¼š

```python
class Counter:
    def __init__(self):
        self.count = 0
    def add(self):
        self.count += 1
        return self.count

c = Counter()
```

é—­åŒ…å®ç°ï¼š

```python
def counter():
    count = 0
    def add():
        nonlocal count
        count += 1
        return count
    return add
```

ä»€ä¹ˆæ—¶å€™ç”¨å“ªä¸€ä¸ªï¼Ÿ

| åœºæ™¯                       | æ¨è |
| -------------------------- | ---- |
| æ•°æ®å¤šã€é€»è¾‘å¤æ‚           | ç±»   |
| è½»é‡çº§çŠ¶æ€å­˜å‚¨ã€å‡½æ•°å¼é£æ ¼ | é—­åŒ… |

------

# ğŸ“Œ 9. æœ€å¼ºæ€»ç»“ï¼ˆ10 ç§’æŒæ¡é—­åŒ…ï¼‰

é—­åŒ…æ»¡è¶³ 3 æ¡ä»¶ï¼š

1. å†…éƒ¨å‡½æ•°
2. å¤–éƒ¨å‡½æ•°å˜é‡è¢«å†…éƒ¨å‡½æ•°ä½¿ç”¨
3. å¤–éƒ¨å‡½æ•°è¿”å›å†…éƒ¨å‡½æ•°

ç”¨é€”ï¼š

- ä¿å­˜çŠ¶æ€
- å·¥å‚æ¨¡å¼
- è£…é¥°å™¨åŸºç¡€
- å»¶è¿Ÿè®¡ç®—

å…³é”®è¯­æ³•ï¼š

`nonlocal` ç”¨äºä¿®æ”¹å¤–éƒ¨å˜é‡ã€‚

