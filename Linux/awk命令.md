# 1. åŸºç¡€è¯­æ³•

## æœ€åŸºæœ¬çš„ç»“æ„

```bash
awk 'pattern { action }' file
```

pattern ä»£è¡¨æ¡ä»¶ï¼Œä¸æ»¡è¶³æ¡ä»¶å°±ä¸æ‰§è¡Œ actionã€‚

### ä¸å†™æ¡ä»¶ â†’ é»˜è®¤æ¯è¡Œéƒ½æ‰§è¡Œ

```bash
awk '{print $0}' file
```

ç­‰åŒäºï¼š

```bash
cat file
```

------

# 2. AWK å†…ç½®å˜é‡ï¼ˆè¶…çº§è¯¦ç»†ï¼‰

| å˜é‡          | ä½œç”¨                             |
| ------------- | -------------------------------- |
| `$0`          | å½“å‰æ•´è¡Œå†…å®¹                     |
| `$1,$2...$NF` | å½“å‰è¡Œçš„ç¬¬ N åˆ—                  |
| `FS`          | è¾“å…¥å­—æ®µåˆ†éš”ç¬¦ï¼ˆé»˜è®¤ä¸ºç©ºæ ¼ï¼‰     |
| `OFS`         | è¾“å‡ºå­—æ®µåˆ†éš”ç¬¦ï¼ˆé»˜è®¤ä¸ºç©ºæ ¼ï¼‰     |
| `RS`          | è¾“å…¥è¡Œåˆ†éš”ç¬¦                     |
| `ORS`         | è¾“å‡ºè¡Œåˆ†éš”ç¬¦                     |
| `NF`          | å­—æ®µæ•°é‡                         |
| `NR`          | å½“å‰è¡Œå·ï¼ˆå…¨å±€ï¼‰                 |
| `FNR`         | å½“å‰æ–‡ä»¶å†…çš„è¡Œå·ï¼ˆå¤šæ–‡ä»¶æ—¶ä¸åŒï¼‰ |
| `FILENAME`    | å½“å‰æ–‡ä»¶å                       |
| `ARGC`        | å‘½ä»¤è¡Œå‚æ•°æ•°é‡                   |
| `ARGV`        | å‘½ä»¤è¡Œå‚æ•°æ•°ç»„                   |

------

# 3. æ¡ä»¶

## æ¯”è¾ƒ

```bash
$1 == "root"
$3 > 100
$2 <= 50
```

## æ­£åˆ™åŒ¹é…

```bash
$0 ~ /error/
$1 !~ /^[0-9]+$/
```

## èŒƒå›´åŒ¹é…ï¼ˆä¸¤è¡Œä¹‹é—´ï¼‰

```bash
awk '/BEGIN/,/END/' file
```

------

# 4. è¿ç®—ä¸å†…ç½®å‡½æ•°

## æ•°å­¦è¿ç®—

```
+  -  *  /  %  
^ï¼ˆæ¬¡æ–¹ï¼‰
```

## å¸¸ç”¨å‡½æ•°

| å‡½æ•°                | è¯´æ˜               |
| ------------------- | ------------------ |
| `length()`          | å­—ç¬¦ä¸²é•¿åº¦         |
| `substr(s,pos,len)` | æˆªå–               |
| `index(s,sub)`      | æŸ¥æ‰¾ substr çš„ä½ç½® |
| `split(s,a,delim)`  | æ‹†åˆ†æˆæ•°ç»„         |
| `tolower()`         | å°å†™               |
| `toupper()`         | å¤§å†™               |
| `gsub(r,s)`         | å…¨å±€æ›¿æ¢           |
| `sub(r,s)`          | æ›¿æ¢ä¸€æ¬¡           |
| `sprintf()`         | æ ¼å¼åŒ–             |

ç¤ºä¾‹ï¼šæ›¿æ¢

```bash
awk '{gsub("error", "ERROR"); print}' log.txt
```

------

# 5. BEGIN / END å—

### BEGINï¼šä»»ä½•æ•°æ®è¡Œè¯»å–å‰æ‰§è¡Œ

```bash
awk 'BEGIN{print "Start"}'
```

### ENDï¼šå…¨éƒ¨å¤„ç†å®Œåæ‰§è¡Œ

```bash
awk '{sum += $2} END {print sum}'
```

------

# 6. æ•°ç»„ä¸å…³è”æ•°ç»„ï¼ˆAWK æœ€å¼ºèƒ½åŠ›ï¼‰

## æ™®é€šæ•°ç»„

```bash
arr[1] = 10
arr[2] = 20
```

## å…³è”æ•°ç»„ï¼ˆå­—å…¸ï¼‰

```bash
count[$1]++
```

éå†ï¼š

```bash
for (i in count)
    print i, count[i]
```

------

# 7. å¤šæ–‡ä»¶å¤„ç†

## NR ä¸ FNR

å¤šæ–‡ä»¶æ—¶ï¼š

| å˜é‡  | è¯´æ˜               |
| ----- | ------------------ |
| `NR`  | æ‰€æœ‰æ–‡ä»¶çš„ç´¯è®¡è¡Œå· |
| `FNR` | å½“å‰æ–‡ä»¶çš„è¡Œå·     |

### ä¾‹ï¼šæ‹¼æ¥ä¸¤ä¸ªæ–‡ä»¶æ¯è¡Œå¯¹åº”å†…å®¹

```bash
awk 'FNR==NR {a[FNR]=$0; next} {print a[FNR], $0}' file1 file2
```

------

# 8. è‡ªå®šä¹‰å‡½æ•°

```bash
awk '
function add(x,y){
    return x+y
}
{print add($1,$2)}' file
```

------

# 9. AWK è„šæœ¬æ–‡ä»¶

åˆ›å»ºè„šæœ¬ï¼š

```awk
#!/usr/bin/awk -f
{print $1,$3}
```

æ‰§è¡Œï¼š

```bash
chmod +x script.awk
./script.awk file
```

------

# 10. è¶…çº§å®æˆ˜æ¡ˆä¾‹ï¼ˆ20+ï¼‰

------

# ğŸ“Œ å®æˆ˜ 1ï¼šç»Ÿè®¡è®¿é—® IP æ•°é‡ TOP10 (nginx)

```bash
awk '{ip[$1]++} END {for (i in ip) print ip[i], i}' access.log | sort -nr | head
```

------

# ğŸ“Œ å®æˆ˜ 2ï¼šç»Ÿè®¡æ¯åˆ†é’Ÿ QPS

```bash
awk '{t=substr($4,14,5); q[t]++} END {for (i in q) print i, q[i]}' access.log
```

------

# ğŸ“Œ å®æˆ˜ 3ï¼šç»Ÿè®¡ HTTP çŠ¶æ€ç æ¯”ä¾‹

```bash
awk '{code[$9]++} END {
    for (c in code) print c, code[c]
}' access.log
```

------

# ğŸ“Œ å®æˆ˜ 4ï¼šæŸ¥æ‰¾è€—æ—¶è¶…è¿‡ 1 ç§’çš„è¯·æ±‚

```bash
awk '$NF > 1' access.log
```

------

# ğŸ“Œ å®æˆ˜ 5ï¼šCSV è½¬ JSON

```bash
awk -F, '{
    print "{"
    print "  \"name\": \"" $1 "\","
    print "  \"age\": " $2
    print "}"
}' file.csv
```

------

# ğŸ“Œ å®æˆ˜ 6ï¼šç»Ÿè®¡æ¯ä¸ªç”¨æˆ·å ç”¨çš„å†…å­˜ç™¾åˆ†æ¯”ï¼ˆps auxï¼‰

```bash
ps aux | awk '{mem[$1]+=$4} END {for(i in mem) print i, mem[i]}'
```

------

# ğŸ“Œ å®æˆ˜ 7ï¼šæå– error å‰å 5 è¡Œ

```bash
awk '/error/ {print "----"; for(i=NR-5;i<=NR+5;i++) print a[i]; print "----"} {a[NR]=$0}' file
```

------

# ğŸ“Œ å®æˆ˜ 8ï¼šæŒ‰åˆ—æ’åºå¹¶è¾“å‡ºï¼ˆæ¨¡æ‹Ÿ sortï¼‰

```bash
awk '{print $2, $1}' file | sort -n
```

------

# ğŸ“Œ å®æˆ˜ 9ï¼šç»Ÿè®¡æ–‡æœ¬ä¸­å­—é¢‘

```bash
awk '{
    for(i=1;i<=NF;i++) freq[$i]++
}
END {for(w in freq) print w, freq[w]}' file
```

------

# ğŸ“Œ å®æˆ˜ 10ï¼šåˆå¹¶ä¸¤ä¸ªå­—æ®µå½¢æˆæ–°å­—æ®µ

```bash
awk '{print $1 "-" $2}' file
```

------

# ğŸ“Œ å®æˆ˜ 11ï¼šåˆ é™¤ç©ºè¡Œ

```bash
awk 'NF>0' file
```

------

# ğŸ“Œ å®æˆ˜ 12ï¼šæ‰“å°å€’æ•°ç¬¬äºŒåˆ—

```bash
awk '{print $(NF-1)}'
```

------

# ğŸ“Œ å®æˆ˜ 13ï¼šæ ¼å¼åŒ–è¾“å‡ºï¼ˆåƒ printfï¼‰

```bash
awk '{printf "%-10s %-5s\n", $1, $2}' file
```

------

# ğŸ“Œ å®æˆ˜ 14ï¼šåŒ¹é…ä¸¤ä¸ªå…³é”®å­—ä¹‹é—´çš„å†…å®¹

```bash
awk '/START/,/END/' file
```

------

# ğŸ“Œ å®æˆ˜ 15ï¼šä»æ—¥å¿—ä¸­æå– URL

```bash
awk '{print $7}' access.log
```

------

# ğŸ“Œ å®æˆ˜ 16ï¼šæŒ‰ç”¨æˆ·ç»Ÿè®¡æ€» CPU

```bash
ps aux | awk '{cpu[$1]+=$3} END {for (i in cpu) print i, cpu[i]}'
```

------

# ğŸ“Œ å®æˆ˜ 17ï¼šä» syslog è§£ææ—¥æœŸ + ä¿¡æ¯

```bash
awk '{print $1,$2,$3,$5,$6,$7}' /var/log/syslog
```

------

# ğŸ“Œ å®æˆ˜ 18ï¼šæå– JSON å­—æ®µ

```bash
awk -F'"' '/"status":/ {print $4}' log.json
```

------

# ğŸ“Œ å®æˆ˜ 19ï¼šæŒ‰æ¡ä»¶åŒæ—¶å¤„ç†å¤šæ–‡ä»¶

```bash
awk 'FNR==NR {a[$1]=$2;next} {print $1,a[$1]}' file1 file2
```

------

# ğŸ“Œ å®æˆ˜ 20ï¼šç»Ÿè®¡æ—¥å¿—å¹³å‡å“åº”æ—¶é—´

```bash
awk '{sum+=$NF; count++} END {print "avg=",sum/count}'
```

------

# ğŸ“Œ å®æˆ˜ 21ï¼šæŒ‰ key=value è§£æé…ç½®æ–‡ä»¶

```bash
awk -F= '!/^#/ && NF==2 {print $1,$2}' config.cfg
```

------

# ğŸ“Œ å®æˆ˜ 22ï¼šç›‘æ§æ•°æ®èšåˆï¼ˆä¾‹å¦‚ CPU åˆ©ç”¨ç‡ï¼‰

```bash
awk '{cpu[$1]+=$2; count[$1]++} END {
    for (i in cpu) print i, cpu[i]/count[i]
}'
```

------

# ğŸ“Œ å®æˆ˜ 23ï¼šSkyWalking/JSON/Proto è¡Œè§£æï¼ˆä¸ä½ çš„ä¸šåŠ¡ç›¸å…³ï¼‰

è§£æå­—æ®µï¼š

```bash
awk -F'"' '/traceId/ {print $4}' skywalking_trace.json
```

