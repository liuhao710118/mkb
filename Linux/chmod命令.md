# 一、chmod 是什么？

`chmod`（**change mode**）用于**修改文件或目录的访问权限**。

```bash
chmod [选项] MODE 文件/目录
```

------

# 二、Linux 权限模型（核心原理）

## 1️⃣ 三类用户（Who）

| 标识 | 含义               |
| ---- | ------------------ |
| u    | 文件所有者（user） |
| g    | 所属组（group）    |
| o    | 其他用户（others） |
| a    | 所有人（u+g+o）    |

------

## 2️⃣ 三种权限（Permission）

| 权限 | 字母 | 数值 | 文件含义 | 目录含义  |
| ---- | ---- | ---- | -------- | --------- |
| 读   | r    | 4    | 读取内容 | 列出目录  |
| 写   | w    | 2    | 修改内容 | 新建/删除 |
| 执行 | x    | 1    | 执行程序 | 进入目录  |

⚠️ **目录没有 x 权限 = 不能 cd**

------

## 3️⃣ 权限结构示意

```text
-rwxr-xr--
│││││││││
││││││││└─ 其他用户
│││││││└── 其他用户
││││││└─── 其他用户
│││││└──── 组用户
││││└───── 组用户
│││└────── 组用户
││└─────── 所有者
│└──────── 所有者
└───────── 文件类型
```

------

# 三、chmod 的两种用法（重点）

------

## 方式一：**数字（八进制）模式 ⭐最常用**

### 1️⃣ 数值规则

```text
r = 4
w = 2
x = 1
```

组合：

```text
7 = 4+2+1 = rwx
6 = 4+2   = rw-
5 = 4+1   = r-x
4 = 4     = r--
0 = ---   = 无权限
```

------

### 2️⃣ 常见权限组合（必须记）

| 权限 | 含义             |
| ---- | ---------------- |
| 777  | 所有人可读写执行 |
| 755  | 程序 / 目录      |
| 644  | 普通文件         |
| 600  | 私密文件         |
| 700  | 私有目录         |

------

### 3️⃣ 示例

```bash
chmod 755 app.sh
chmod 644 config.yaml
chmod 600 id_rsa
```

------

## 方式二：**符号（字母）模式**

### 1️⃣ 基本格式

```bash
chmod [who][operator][permission] file
```

| 部分       | 含义                      |
| ---------- | ------------------------- |
| who        | u / g / o / a             |
| operator   | +（加） -（减） =（设定） |
| permission | r / w / x                 |

------

### 2️⃣ 示例

```bash
chmod u+x script.sh     # 所有者加执行
chmod g-w file.txt     # 组移除写
chmod o+r file.txt     # 其他人加读
chmod a=rx file.sh     # 所有人设为 rx
```

------

# 四、递归修改（目录专用）

```bash
chmod -R 755 /opt/app
```

⚠️ **危险操作**，会修改整个目录树

------

## 更安全的做法（推荐）

```bash
# 目录给 755
find /opt/app -type d -exec chmod 755 {} \;

# 文件给 644
find /opt/app -type f -exec chmod 644 {} \;
```

------

# 五、特殊权限（高级但常见）

## 1️⃣ SUID（4）

```bash
chmod 4755 /usr/bin/passwd
```

- 用于 **可执行文件**
- 运行时拥有文件所有者权限

------

## 2️⃣ SGID（2）

```bash
chmod 2755 dir
```

- 目录下新文件继承组

------

## 3️⃣ Sticky Bit（1）

```bash
chmod 1777 /tmp
```

- 只有文件所有者才能删除
- `/tmp` 标准权限

------

## 4️⃣ 数字权限位总结

```text
4xxx → SUID
2xxx → SGID
1xxx → Sticky
```

------

# 六、文件 vs 目录 权限区别（⚠️ 易错）

| 权限 | 文件     | 目录      |
| ---- | -------- | --------- |
| r    | 查看内容 | ls        |
| w    | 修改内容 | 创建/删除 |
| x    | 执行     | cd        |

👉 **目录没有 x 权限，r/w 都没意义**

------

# 七、实战场景大全

## 1️⃣ 脚本无法执行

```bash
chmod +x deploy.sh
./deploy.sh
```

------

## 2️⃣ Web 目录

```bash
目录：755
文件：644
```

------

## 3️⃣ SSH 私钥权限错误

```bash
chmod 600 ~/.ssh/id_rsa
```

------

## 4️⃣ Dockerfile 中

```dockerfile
RUN chmod +x /app/start.sh
```

------

## 5️⃣ Kubernetes InitContainer

```bash
chmod -R 755 /data
```

------

# 八、常见错误 & 排查

### ❌ Permission denied

```bash
ls -l 文件
id 用户
```

### ❌ chmod 无效

- 没有文件所有权
- FAT / NTFS 文件系统
- 挂载为只读

------

# 九、权限速查表（终极记忆）

```text
目录      755
脚本      755
配置文件  644
私钥      600
临时目录  1777
```

