Elasticsearch çš„ Mapping ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„è¡¨ç»“æ„å®šä¹‰ï¼Œå®ƒå†³å®šäº†æ•°æ®å¦‚ä½•è¢«å­˜å‚¨å’Œç´¢å¼•ï¼Œç›´æ¥å½±å“æœç´¢æ€§èƒ½å’Œç»“æœçš„å‡†ç¡®æ€§ã€‚ä¸‹é¢è¿™ä¸ªè¡¨æ ¼å¸®ä½ å¿«é€Ÿäº†è§£ Mapping çš„æ ¸å¿ƒè¦ç´ å’Œè®¾è®¡è¦ç‚¹ã€‚

| Mapping ç»„ä»¶/æ¦‚å¿µ                  | æ ¸å¿ƒè¦ç‚¹/å¸¸ç”¨é…ç½®                                            | è¯´æ˜/æ³¨æ„äº‹é¡¹                                                |
| ---------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **å­—æ®µç±»å‹ (Data Types)**          | **`text`**: å…¨æ–‡æœç´¢ï¼Œä¼šè¢«åˆ†è¯ã€‚ **`keyword`**: ç²¾ç¡®åŒ¹é…ã€æ’åºã€èšåˆï¼Œä¸åˆ†è¯ã€‚ **æ•°å€¼ç±»å‹** (`integer`, `float`ç­‰): èŒƒå›´æŸ¥è¯¢ã€èšåˆã€‚ **`date`**: æ—¥æœŸæ—¶é—´ï¼Œéœ€æŒ‡å®š `format`ã€‚ **`nested`**: åµŒå¥—å¯¹è±¡æ•°ç»„ï¼Œæ”¯æŒç‹¬ç«‹æŸ¥è¯¢ã€‚ | ä¸ºéœ€è¦**å…¨æ–‡æ£€ç´¢**çš„å­—æ®µï¼ˆå¦‚æ–‡ç« å†…å®¹ï¼‰é€‰æ‹© `text`ç±»å‹ï¼›ä¸ºéœ€è¦**ç²¾ç¡®åŒ¹é…ã€æ’åºæˆ–èšåˆ**çš„å­—æ®µï¼ˆå¦‚çŠ¶æ€ã€æ ‡ç­¾ï¼‰é€‰æ‹© `keyword`ç±»å‹ã€‚ä½¿ç”¨ `nested`ç±»å‹å¤„ç†æ•°ç»„å¯¹è±¡ï¼Œé¿å…å…³è”æŸ¥è¯¢é”™è¯¯ã€‚ |
| **æ ¸å¿ƒå‚æ•° (Parameters)**          | **`index`**: æ§åˆ¶å­—æ®µæ˜¯å¦å¯è¢«æœç´¢ã€‚ **`analyzer`**: æŒ‡å®šç´¢å¼•æ—¶çš„åˆ†è¯å™¨ã€‚ **`search_analyzer`**: æŒ‡å®šæœç´¢æ—¶çš„åˆ†è¯å™¨ã€‚ **`doc_values`**: æ§åˆ¶å­—æ®µæ˜¯å¦å¯ç”¨äºæ’åºã€èšåˆã€‚ **`fields`**: å®ç°å¤šå­—æ®µï¼Œå¦‚åŒæ—¶å®šä¹‰ `text`å’Œ `keyword`ã€‚ | å¯¹ç»å¯¹ä¸éœ€è¦æŸ¥è¯¢çš„å­—æ®µè®¾ç½® `"index": false`ä»¥èŠ‚çœç©ºé—´ã€‚é€šè¿‡ `fields`å‚æ•°ï¼Œå¯å¯¹ä¸€ä¸ªå­—æ®µåŒæ—¶å®šä¹‰å¤šç§ç´¢å¼•æ–¹å¼ï¼Œå…¼é¡¾å…¨æ–‡æœç´¢å’Œç²¾ç¡®åŒ¹é…ã€‚ |
| **åŠ¨æ€ Mapping (Dynamic Mapping)** | **`"dynamic": true`** (é»˜è®¤): è‡ªåŠ¨è¯†åˆ«å¹¶æ·»åŠ æ–°å­—æ®µã€‚ **`"dynamic": false`**: å¿½ç•¥æ–°å­—æ®µï¼ˆä¸ç´¢å¼•ï¼Œä½†å­˜å‚¨åœ¨ `_source`ï¼‰ã€‚ **`"dynamic": "strict"`**: é‡åˆ°æœªå®šä¹‰å­—æ®µæ—¶æŠ¥é”™ï¼Œå¼ºåˆ¶ schemaã€‚ | ç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ä¸º `strict`æˆ– `false`ï¼Œé¿å…è‡ªåŠ¨æ¨æ–­å­—æ®µç±»å‹ä¸å½“å¯¼è‡´åç»­é—®é¢˜ã€‚ |
| **å…ƒå­—æ®µ (Meta-Fields)**           | **`_source`**: å­˜å‚¨æ–‡æ¡£çš„åŸå§‹ JSON å†…å®¹ã€‚ **`_all`**: (å·²åœ¨é«˜ç‰ˆæœ¬åºŸå¼ƒï¼Œç”± `copy_to`æ›¿ä»£) å°†æ‰€æœ‰å­—æ®µå€¼å¤åˆ¶åˆ°ä¸€ä¸ªå¤§å­—æ®µä¸­è¿›è¡Œæœç´¢ã€‚ | ç¦ç”¨ `_source`å¯èŠ‚çœç©ºé—´ï¼Œä½†å°†æ— æ³•é€šè¿‡æœç´¢è¿”å›åŸå§‹æ–‡æ¡£ã€æ— æ³•é‡å»ºç´¢å¼•æˆ–æ›´æ–°æ–‡æ¡£ï¼Œé€šå¸¸ä¸å»ºè®®ç¦ç”¨ã€‚ |



## ä¸€ã€ä»€ä¹ˆæ˜¯ Mappingï¼ˆæ˜ å°„ï¼‰

**Mapping = ç´¢å¼•ä¸­å­—æ®µçš„ç»“æ„å®šä¹‰ï¼ˆSchemaï¼‰**

ç±»ä¼¼äºï¼š

| ç³»ç»Ÿ          | å¯¹åº”æ¦‚å¿µ           |
| ------------- | ------------------ |
| MySQL         | è¡¨ç»“æ„ï¼ˆå­—æ®µç±»å‹ï¼‰ |
| Elasticsearch | Mapping            |

Mapping å†³å®šäº†ï¼š

- å­—æ®µå¦‚ä½• **å­˜å‚¨**
- æ˜¯å¦ **åˆ†è¯**
- èƒ½å¦ **æœç´¢ / æ’åº / èšåˆ**
- å­—æ®µå ç”¨å¤šå°‘ **ç£ç›˜ä¸å†…å­˜**

> âš ï¸ ä¸€æ—¦å­—æ®µç±»å‹ç¡®å®šï¼Œ**ä¸èƒ½ç›´æ¥ä¿®æ”¹**ï¼ˆåªèƒ½æ–°å»ºç´¢å¼•é‡å»ºæ•°æ®ï¼‰

------

## äºŒã€Mapping çš„æ•´ä½“ç»“æ„

ä¸€ä¸ªç´¢å¼•çš„ mapping å¤§è‡´é•¿è¿™æ ·ï¼š

```json
PUT my_index
{
  "mappings": {
    "properties": {
      "name": {
        "type": "text"
      },
      "age": {
        "type": "integer"
      },
      "created_at": {
        "type": "date"
      }
    }
  }
}
```

æ ¸å¿ƒåªæœ‰ä¸€ä¸ªä¸œè¥¿ï¼š

```
mappings
 â””â”€â”€ properties
      â””â”€â”€ å­—æ®µå
           â””â”€â”€ å­—æ®µç±»å‹ + å‚æ•°
```

------

## ä¸‰ã€å¸¸è§å­—æ®µç±»å‹ï¼ˆé‡ç‚¹ï¼‰

### 1ï¸âƒ£ å­—ç¬¦ä¸²ç±»å‹ï¼ˆæœ€é‡è¦ï¼‰

#### ğŸ”¹ textï¼ˆå…¨æ–‡æ£€ç´¢ï¼‰

```json
"title": {
  "type": "text"
}
```

ç‰¹ç‚¹ï¼š

- **ä¼šåˆ†è¯**
- ç”¨äºå…¨æ–‡æœç´¢ï¼ˆmatchï¼‰
- âŒ ä¸èƒ½æ’åºã€èšåˆï¼ˆé»˜è®¤ï¼‰

ä½¿ç”¨åœºæ™¯ï¼š

- æ–‡ç« å†…å®¹
- æ—¥å¿— message
- æè¿°æ€§å­—æ®µ

------

#### ğŸ”¹ keywordï¼ˆç²¾ç¡®åŒ¹é…ï¼‰

```json
"status": {
  "type": "keyword"
}
```

ç‰¹ç‚¹ï¼š

- **ä¸åˆ†è¯**
- ç²¾ç¡®åŒ¹é…
- å¯ç”¨äº **èšåˆ / æ’åº / term æŸ¥è¯¢**

ä½¿ç”¨åœºæ™¯ï¼š

- çŠ¶æ€ç 
- IP
- ä¸»æœºå
- æœåŠ¡å

------

#### ğŸ”¹ text + keywordï¼ˆæœ€å¸¸ç”¨ç»„åˆï¼‰

```json
"service_name": {
  "type": "text",
  "fields": {
    "keyword": {
      "type": "keyword"
    }
  }
}
```

ä½¿ç”¨æ–¹å¼ï¼š

```json
# æœç´¢
"match": { "service_name": "order" }

# èšåˆ
"terms": { "field": "service_name.keyword" }
```

âœ… **å¼ºçƒˆæ¨èæ—¥å¿— / è¿ç»´åœºæ™¯**

------

### 2ï¸âƒ£ æ•°å€¼ç±»å‹

| ç±»å‹         | è¯´æ˜               |
| ------------ | ------------------ |
| integer      | æ•´æ•°               |
| long         | é•¿æ•´å‹             |
| float        | æµ®ç‚¹               |
| double       | é«˜ç²¾åº¦æµ®ç‚¹         |
| scaled_float | èŠ‚çœç©ºé—´ï¼ˆ*é‡è¦*ï¼‰ |

```json
"cpu_usage": {
  "type": "scaled_float",
  "scaling_factor": 100
}
```

å­˜å‚¨ï¼š

- `12.34` â†’ `1234`
- çœç£ç›˜ + èšåˆå¿«

------

### 3ï¸âƒ£ æ—¥æœŸç±»å‹

```json
"@timestamp": {
  "type": "date",
  "format": "strict_date_optional_time||epoch_millis"
}
```

æ”¯æŒï¼š

- `"2025-01-01T10:00:00Z"`
- `1700000000000`

ğŸ“Œ æ—¥å¿—ã€ç›‘æ§å¿…å¤‡å­—æ®µ

------

### 4ï¸âƒ£ å¸ƒå°”ç±»å‹

```json
"is_error": {
  "type": "boolean"
}
```

------

### 5ï¸âƒ£ IP ç±»å‹ï¼ˆè¿ç»´å¾ˆå¸¸ç”¨ï¼‰

```json
"client_ip": {
  "type": "ip"
}
```

æ”¯æŒï¼š

- IPv4
- IPv6
- CIDR æŸ¥è¯¢

------

### 6ï¸âƒ£ å¯¹è±¡ç±»å‹ï¼ˆObjectï¼‰

```json
"host": {
  "properties": {
    "name": { "type": "keyword" },
    "ip": { "type": "ip" }
  }
}
```

è®¿é—®æ–¹å¼ï¼š

```
host.name
host.ip
```

------

### 7ï¸âƒ£ nestedï¼ˆåµŒå¥—å¯¹è±¡ï¼Œâš ï¸é‡ç‚¹ï¼‰

```json
"spans": {
  "type": "nested",
  "properties": {
    "span_id": { "type": "keyword" },
    "duration": { "type": "long" }
  }
}
```

ä¸ºä»€ä¹ˆéœ€è¦ nestedï¼Ÿ

- é˜²æ­¢ **æ•°ç»„å¯¹è±¡å­—æ®µé”™é…**

```json
{
  "spans": [
    {"span_id": "1", "duration": 100},
    {"span_id": "2", "duration": 200}
  ]
}
```

å¦‚æœä¸ç”¨ nestedï¼ŒæŸ¥è¯¢å¯èƒ½é”™ä¹± âŒ

------

## å››ã€Dynamic Mappingï¼ˆåŠ¨æ€æ˜ å°„ï¼‰

### é»˜è®¤è¡Œä¸ºï¼ˆâš ï¸å‘ç‚¹ï¼‰

```json
PUT index/_doc/1
{
  "status": "ok",
  "count": 10
}
```

ES ä¼šè‡ªåŠ¨æ¨æ–­ï¼š

- `"ok"` â†’ text + keyword
- `10` â†’ long

âŒ é—®é¢˜ï¼š

- å­—æ®µç±»å‹ä¸å¯æ§
- keyword å¤ªå¤š â†’ å†…å­˜çˆ†

------

### å…³é—­åŠ¨æ€æ˜ å°„ï¼ˆæ¨èï¼‰

```json
"dynamic": "strict"
PUT my_index
{
  "mappings": {
    "dynamic": "strict",
    "properties": {
      "status": { "type": "keyword" }
    }
  }
}
```

æœªå®šä¹‰å­—æ®µ â†’ ç›´æ¥æŠ¥é”™

------

### Dynamic Templateï¼ˆè¿ç»´å¿…ä¼šï¼‰

```json
"dynamic_templates": [
  {
    "strings_as_keyword": {
      "match_mapping_type": "string",
      "mapping": {
        "type": "keyword"
      }
    }
  }
]
```

æ•ˆæœï¼š

- æ‰€æœ‰å­—ç¬¦ä¸² â†’ keyword
- é˜²æ­¢ text æ»¥ç”¨

------

## äº”ã€å¸¸ç”¨ Mapping å‚æ•°

### ğŸ”¹ index

```json
"index": false
```

ä¸å…è®¸æœç´¢ï¼ˆä½†å¯å­˜å‚¨ï¼‰

------

### ğŸ”¹ doc_valuesï¼ˆèšåˆæ€§èƒ½ï¼‰

```json
"doc_values": true
```

- keyword / number é»˜è®¤å¼€å¯
- text é»˜è®¤å…³é—­

------

### ğŸ”¹ analyzerï¼ˆåˆ†è¯å™¨ï¼‰

```json
"title": {
  "type": "text",
  "analyzer": "ik_max_word"
}
```

------

### ğŸ”¹ null_value

```json
"status": {
  "type": "keyword",
  "null_value": "UNKNOWN"
}
```

------

## å…­ã€å®Œæ•´å®æˆ˜ Mappingï¼ˆæ—¥å¿— / è¿ç»´ï¼‰

```json
PUT logs_index
{
  "mappings": {
    "dynamic": false,
    "properties": {
      "@timestamp": { "type": "date" },
      "level": { "type": "keyword" },
      "service": {
        "type": "keyword"
      },
      "message": {
        "type": "text"
      },
      "host": {
        "properties": {
          "name": { "type": "keyword" },
          "ip": { "type": "ip" }
        }
      },
      "duration_ms": {
        "type": "long"
      }
    }
  }
}
```

------

## ä¸ƒã€å¸¸è§å‘æ€»ç»“ï¼ˆéå¸¸é‡è¦ï¼‰

### âŒ 1. text å­—æ®µåšèšåˆ

â¡ å¿…é¡»ç”¨ `.keyword`

### âŒ 2. åŠ¨æ€ mapping å¤±æ§

â¡ ç”¨ `dynamic:false` + template

### âŒ 3. nested ä¸ object æ··æ·†

â¡ æ•°ç»„å¯¹è±¡ â†’ nested

### âŒ 4. mapping é¢‘ç¹å˜æ›´

â¡ ç”¨ **index template + ç‰ˆæœ¬åŒ–ç´¢å¼•**

## å…«ã€Mappingç®¡ç†

### åˆ›å»ºç´¢å¼•

```bash
PUT {index_name}
{
  "mappings": {
    "dynamic": "strict",
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "ik_max_word",
        "fields": {
          "raw": { "type": "keyword" }
        }
      },
      "publish_date": { "type": "date", "format": "yyyy-MM-dd" }
    }
  }
}
```

### æŸ¥çœ‹ç´¢å¼•

```bash
GET {index_name}/_mapping
```

### æ–°å¢å­—æ®µ 

å·²æœ‰ Mapping æ— æ³•ä¿®æ”¹å­—æ®µç±»å‹ï¼Œä½†å¯æ–°å¢å­—æ®µ

```bash
PUT {index_name}/_mapping
{
  "properties": {
    "new_field": { "type": "keyword" }
  }
}
```

### åˆ é™¤ç´¢å¼•

```bash
DELETE {index_name}
```